ARG RUBY_VERSION=3.4.2
FROM ruby:$RUBY_VERSION

# Install system dependencies
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    npm \
    curl \
    nodejs \
    libpq-dev \
    build-essential \
    postgresql-client \
    git && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install Yarn with Corepack
RUN npm install -g corepack && corepack enable

WORKDIR /rails

# Install foreman
RUN gem install foreman

# Copy and install gems
COPY Gemfile Gemfile.lock ./
RUN bundle install

# Copy and install node modules
COPY package.json yarn.lock ./
RUN yarn install

# Copy application code
COPY . .

# Ensure node_modules are properly installed
RUN yarn install

# Expose ports for Rails (3000) and Vite (3036)
EXPOSE 3000 3036

# Set environment variables for Rails to bind to all interfaces
ENV RAILS_SERVE_STATIC_FILES=true
ENV BIND=0.0.0.0

# Start development server
CMD ["bin/dev"]